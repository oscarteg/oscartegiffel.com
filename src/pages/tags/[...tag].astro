---
import { getCollection } from "astro:content";
import dayjs from "dayjs";
import BlogPost from "../../components/BlogPost.astro";
import DefaultLayout from "../../layouts/default.astro";
import type { Post } from "../../models";

// 1. Get the slug from the incoming server request
const { tag } = Astro.params;

if (tag === undefined) {
  throw new Error("Slug is required");
}

const isProd = import.meta.env.PROD;
const posts = await getCollection("blog");
const filteredPosts = posts
  .filter(({ data }: Post) => (isProd ? !data.draft : true))
  .filter(({ data }: Post) => (isProd ? dayjs(data.publishDate).isBefore(dayjs()) : true))
  .filter(({ data }: Post) => data.tags.includes(tag))
  .sort((a: Post, b: Post) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());
---

<DefaultLayout prose={false} title={tag}>
  <ul role="list" class="divide-y divide-zinc-700 flex flex-col">
    {filteredPosts.map((post: Post) => <BlogPost post={post} />)}
  </ul>
</DefaultLayout>
